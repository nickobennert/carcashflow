<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Changelog - Fahr mit! Entwicklungssession</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6; color: #1a1a1a; max-width: 900px;
      margin: 0 auto; padding: 40px 20px; background: #fff;
    }
    h1 { font-size: 2rem; margin-bottom: 0.5rem; color: #111; border-bottom: 3px solid #10b981; padding-bottom: 0.5rem; }
    h2 { font-size: 1.5rem; margin-top: 2rem; margin-bottom: 1rem; color: #111; border-bottom: 1px solid #e5e5e5; padding-bottom: 0.3rem; }
    h3 { font-size: 1.1rem; margin-top: 1.5rem; margin-bottom: 0.5rem; color: #333; }
    h4 { font-size: 1rem; margin-top: 1rem; margin-bottom: 0.3rem; color: #555; }
    p { margin-bottom: 0.8rem; }
    .meta { color: #666; font-size: 0.9rem; margin-bottom: 2rem; }
    .section { margin-bottom: 2rem; page-break-inside: avoid; }
    .feature-box {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 2px solid #10b981; border-radius: 12px;
      padding: 1.5rem; margin: 1.5rem 0;
    }
    .feature-box h3 { margin-top: 0; color: #065f46; }
    .bug-item {
      background: #f9fafb; border-left: 4px solid #10b981;
      padding: 1rem; margin-bottom: 1rem; border-radius: 0 8px 8px 0;
    }
    .bug-item h3 { margin-top: 0; color: #111; }
    .problem { color: #dc2626; font-weight: 500; }
    .solution { color: #10b981; font-weight: 500; }
    .files {
      background: #f3f4f6; padding: 0.5rem 1rem; border-radius: 4px;
      font-family: 'Menlo', monospace; font-size: 0.85rem; margin-top: 0.5rem;
    }
    ul { margin-left: 1.5rem; margin-bottom: 1rem; }
    li { margin-bottom: 0.3rem; }
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    th, td { border: 1px solid #e5e5e5; padding: 0.5rem 1rem; text-align: left; }
    th { background: #f3f4f6; font-weight: 600; }
    code {
      background: #f3f4f6; padding: 0.1rem 0.4rem; border-radius: 3px;
      font-family: 'Menlo', monospace; font-size: 0.9em;
    }
    pre {
      background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 8px;
      overflow-x: auto; font-size: 0.85rem; margin: 1rem 0;
    }
    .commit-hash {
      font-family: 'Menlo', monospace; background: #dbeafe;
      padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.85rem;
    }
    .summary-box {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border: 1px solid #86efac; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0;
    }
    .summary-box h3 { margin-top: 0; color: #166534; }
    .removed { color: #dc2626; text-decoration: line-through; }
    .added { color: #10b981; font-weight: 500; }
    hr { border: none; border-top: 1px solid #e5e5e5; margin: 2rem 0; }
    .highlight { background: #fef3c7; padding: 0.2rem 0.5rem; border-radius: 4px; }
    @media print { body { padding: 20px; } .bug-item, .feature-box { break-inside: avoid; } }
  </style>
</head>
<body>

<h1>Changelog - Entwicklungssession</h1>
<p class="meta">
  <strong>Projekt:</strong> Fahr mit! (Carcashflow)<br>
  <strong>Entwickler:</strong> Claude Opus 4.5
</p>

<div class="summary-box">
  <h3>Zusammenfassung</h3>
  <p>Diese Session umfasste die Implementierung eines <strong>vollständigen Routen-Systems</strong> mit echter Straßenberechnung, <strong>intelligentem Matching</strong> und <strong>Route Watches</strong>. Zusätzlich wurden <strong>13+ Mobile-Bugs</strong> behoben und <strong>13 Commits</strong> erstellt.</p>
</div>

<hr>

<h2>1. Routen-System (Hauptfeature)</h2>

<div class="feature-box">
  <h3>Das Herzstück der App</h3>
  <p>Statt Luftlinie werden jetzt <strong>echte Straßenrouten</strong> berechnet. Das Matching erkennt, wenn ein Ort "auf dem Weg" liegt, auch wenn Start/Ziel nicht übereinstimmen.</p>
</div>

<h3>1.1 OSRM Integration - Echte Straßen-Routing</h3>
<p><strong>Datei:</strong> <code>src/lib/routing/osrm.ts</code></p>

<table>
  <thead><tr><th>Eigenschaft</th><th>Details</th></tr></thead>
  <tbody>
    <tr><td>Routing Service</td><td>OSRM (Open Source Routing Machine)</td></tr>
    <tr><td>Kosten</td><td>Kostenlos, kein API-Key erforderlich</td></tr>
    <tr><td>Server</td><td><code>https://router.project-osrm.org</code></td></tr>
    <tr><td>Produktion</td><td>Self-Hosting empfohlen</td></tr>
  </tbody>
</table>

<h4>Kern-Funktionen:</h4>
<table>
  <thead><tr><th>Funktion</th><th>Beschreibung</th></tr></thead>
  <tbody>
    <tr><td><code>calculateRoute(points)</code></td><td>Berechnet Route zwischen 2+ Punkten</td></tr>
    <tr><td><code>decodePolyline()</code></td><td>Dekodiert Google Polyline Format</td></tr>
    <tr><td><code>getInstruction()</code></td><td>Übersetzt Manöver zu deutschen Anweisungen</td></tr>
    <tr><td><code>isPointNearRoute()</code></td><td>Prüft ob ein Punkt auf einer Route liegt</td></tr>
    <tr><td><code>formatDistance()</code></td><td>Formatiert Meter zu "12,5 km"</td></tr>
    <tr><td><code>formatDuration()</code></td><td>Formatiert Sekunden zu "1 Std. 23 Min."</td></tr>
  </tbody>
</table>

<h4>RoutePoint Interface:</h4>
<pre>interface RoutePoint {
  type: "start" | "stop" | "end"  // Art des Halts
  address: string                  // Straßenadresse
  lat: number                      // Breitengrad
  lng: number                      // Längengrad
  order: number                    // Reihenfolge
}</pre>

<h4>RouteResult Interface:</h4>
<pre>interface RouteResult {
  distance: number                  // Gesamtdistanz in Metern
  duration: number                  // Fahrzeit in Sekunden
  geometry: [number, number][]      // Koordinaten für Karte
  steps: RouteStep[]                // Turn-by-Turn (Deutsch)
  waypoints: { name, location }[]   // Berechnete Zwischenpunkte
}</pre>

<hr>

<h3>1.2 Matching-System - Intelligente Fahrtsuche</h3>
<p><strong>Datei:</strong> <code>src/app/api/rides/match/route.ts</code></p>

<div class="feature-box">
  <h3>Das "Düsseldorf liegt auf dem Weg"-Problem gelöst!</h3>
  <p><strong>Problem:</strong> User fährt Rheine → Köln. Rider fährt Düsseldorf → München.<br>
  Düsseldorf liegt auf der Strecke, aber klassisches Matching scheitert.</p>
  <p><strong>Lösung:</strong> Segment-basierte Distanz-Berechnung prüft, ob ein Punkt <em>auf dem Weg</em> liegt!</p>
</div>

<h4>Matching-Algorithmus:</h4>
<pre>FÜR JEDE FAHRT IN DER DATENBANK:

1. Berechne Route-Ähnlichkeit (0-100)
   └─ 0km = 100 Punkte, 50km = 50 Punkte, 100km+ = 0

2. Prüfe 4 Szenarien:
   a) Ist Fahrt-Start auf meiner Route?
   b) Ist Fahrt-Ende auf meiner Route?
   c) Ist mein Start auf der Fahrt-Route?
   d) Ist mein Ziel auf der Fahrt-Route?

3. Corridor Detection (für Zwischenstopps)
   └─ Umweg <= 20% oder thresholdKm
   └─ Stopps im "Korridor" werden erkannt

4. Score & Sortierung
   └─ onTheWay > similarity > minDistance</pre>

<h4>Beispiel Match-Details:</h4>
<pre>{
  "onTheWay": true,
  "similarity": 35,
  "matchDetails": [
    "Start liegt auf deiner Route (12 km)",
    "Fährt über Düsseldorf",
    "Dein Ziel liegt auf dieser Route (8 km)"
  ],
  "minDistance": 8
}</pre>

<hr>

<h3>1.3 Route Watches - Benachrichtigungen bei neuen Fahrten</h3>
<p>User können "warten" auf passende Fahrten und werden automatisch benachrichtigt.</p>

<h4>Zwei Watch-Typen:</h4>
<table>
  <thead><tr><th>Typ</th><th>Beschreibung</th><th>Beispiel</th></tr></thead>
  <tbody>
    <tr>
      <td><strong>Location Watch</strong></td>
      <td>Punkt + Radius überwachen</td>
      <td>"Düsseldorf Umkreis 25km"</td>
    </tr>
    <tr>
      <td><strong>Route Watch</strong></td>
      <td>Start + Ende überwachen</td>
      <td>"Rheine nach Köln"</td>
    </tr>
  </tbody>
</table>

<h4>Trigger-Flow bei neuer Fahrt:</h4>
<pre>1. Neue Fahrt erstellt → POST /api/route-watches/trigger
2. Backend prüft ALLE Watches anderer User
3. Bei Match → Notification erstellen
4. Watcher bekommt Push: "Neue passende Fahrt!"</pre>

<hr>

<h3>1.4 Route-Builder (Frontend)</h3>
<p><strong>Datei:</strong> <code>src/components/rides/create-ride-drawer.tsx</code></p>

<table>
  <thead><tr><th>Feature</th><th>Beschreibung</th></tr></thead>
  <tbody>
    <tr><td><strong>Drag & Drop</strong></td><td>Zwischenstopps per Drag verschieben</td></tr>
    <tr><td><strong>Location Search</strong></td><td>Nominatim API für Adresssuche</td></tr>
    <tr><td><strong>Karten-Klick</strong></td><td>Punkt setzen durch Kartenklick</td></tr>
    <tr><td><strong>Route Visualisierung</strong></td><td>Leaflet Map mit berechneter Route</td></tr>
    <tr><td><strong>Distance/Duration</strong></td><td>Automatische Berechnung via OSRM</td></tr>
    <tr><td><strong>Favoriten</strong></td><td>Häufige Routen speichern & laden</td></tr>
    <tr><td><strong>Live-Matching</strong></td><td>Zeigt passende Fahrten während Eingabe</td></tr>
  </tbody>
</table>

<h4>Recurring Rides (Wiederkehrende Fahrten):</h4>
<ul>
  <li>Wochentage auswählen (Mo-So)</li>
  <li>Dauer wählen (1-12 Wochen)</li>
  <li>Automatische Erstellung: z.B. "4 Tage × 4 Wochen = 16 Fahrten"</li>
  <li>Max. 52 Fahrten (1 Jahr)</li>
</ul>

<hr>

<h3>1.5 Distanz-Berechnungen</h3>

<h4>Haversine Formula:</h4>
<pre>// Berechnet Distanz zwischen zwei Koordinaten
const R = 6371 // Erdradius in km
const dLat = (lat2 - lat1) * (π/180)
const dLng = (lng2 - lng1) * (π/180)
const a = sin(dLat/2)² + cos(lat1) * cos(lat2) * sin(dLng/2)²
const c = 2 * atan2(√a, √(1-a))
return R * c  // Distanz in km</pre>

<h4>Similarity Score:</h4>
<pre>// Wie ähnlich sind zwei Routen?
startScore = MAX(0, 100 - startDistance * 2)
endScore = MAX(0, 100 - endDistance * 2)
similarity = (startScore + endScore) / 2

// Beispiel:
// Start 5km entfernt, Ende 10km entfernt
// = (90 + 80) / 2 = 85% Ähnlichkeit</pre>

<hr>

<h3>1.6 Routen-System Dateien</h3>
<table>
  <thead><tr><th>Datei</th><th>Zweck</th></tr></thead>
  <tbody>
    <tr><td><code>src/lib/routing/osrm.ts</code></td><td>OSRM Routing Engine</td></tr>
    <tr><td><code>src/lib/location-storage.ts</code></td><td>Favoriten, Watches, Distanzen</td></tr>
    <tr><td><code>src/components/map/route-map.tsx</code></td><td>Leaflet Map mit Route</td></tr>
    <tr><td><code>src/components/map/location-search.tsx</code></td><td>Ortssuche & Geocoding</td></tr>
    <tr><td><code>src/components/rides/create-ride-drawer.tsx</code></td><td>Route-Builder UI</td></tr>
    <tr><td><code>src/components/rides/matching-rides.tsx</code></td><td>Passende Fahrten anzeigen</td></tr>
    <tr><td><code>src/components/rides/route-watch-manager.tsx</code></td><td>Watch-Verwaltung UI</td></tr>
    <tr><td><code>src/app/api/rides/route.ts</code></td><td>Fahrt CRUD</td></tr>
    <tr><td><code>src/app/api/rides/match/route.ts</code></td><td><strong>Matching Engine</strong></td></tr>
    <tr><td><code>src/app/api/route-watches/route.ts</code></td><td>Watch CRUD</td></tr>
    <tr><td><code>src/app/api/route-watches/trigger/route.ts</code></td><td>Notification Trigger</td></tr>
  </tbody>
</table>

<hr>

<h2>2. Bugfixes (Kundenfeedback)</h2>

<div class="bug-item">
  <h3>2.1 Mobile Dialoge & Modals</h3>
  <p><span class="problem">Problem:</span> Modals wurden am unteren Bildschirmrand angezeigt statt zentriert.</p>
  <p><span class="solution">Lösung:</span> Alle Modals zentriert, Close-Button mit Blur, responsive Padding.</p>
</div>

<div class="bug-item">
  <h3>2.2 Abo-Auswahl Modal</h3>
  <p><span class="problem">Problem:</span> Modal war zu klein und unübersichtlich.</p>
  <p><span class="solution">Lösung:</span> Größer auf Desktop (max-w-5xl), animierter Gradient-Rahmen für Premium.</p>
</div>

<div class="bug-item">
  <h3>2.3 Einstellungen - Mobile Navigation</h3>
  <p><span class="problem">Problem:</span> Tabs nahmen zu viel Platz auf Mobile ein.</p>
  <p><span class="solution">Lösung:</span> 6-spaltiges Icon-Grid auf Mobile, Labels nur auf Desktop.</p>
</div>

<div class="bug-item">
  <h3>2.4 Admin-Bereich - Nutzer-Tabelle</h3>
  <p><span class="problem">Problem:</span> Tabelle lief horizontal über den Bildschirmrand.</p>
  <p><span class="solution">Lösung:</span> Komplett neue Mobile-Kartenansicht statt Tabelle. Jeder Nutzer als Karte.</p>
  <div class="files">src/components/admin/users-table.tsx</div>
</div>

<div class="bug-item">
  <h3>2.5 Benachrichtigungs-Dropdown</h3>
  <p><span class="problem">Problem:</span> Dropdown schloss nicht beim Öffnen des Dialogs.</p>
  <p><span class="solution">Lösung:</span> Automatisches Schließen, responsive Breite.</p>
</div>

<div class="bug-item">
  <h3>2.6 Routen-Detailseite</h3>
  <p><span class="problem">Problem:</span> Nicht für Mobile optimiert, veraltete Links.</p>
  <p><span class="solution">Lösung:</span></p>
  <ul>
    <li>Responsive Typography und Grid</li>
    <li><span class="removed">Link zum öffentlichen Profil entfernt</span></li>
    <li><span class="added">Neuer Hinweistext: "Schreibe eine Nachricht um Kontakt aufzunehmen"</span></li>
  </ul>
</div>

<div class="bug-item">
  <h3>2.7 Chat/Messages - Horizontales Scrolling</h3>
  <p><span class="problem">Problem:</span> Horizontales Scrollen im Chat auf Mobile möglich.</p>
  <p><span class="solution">Lösung:</span> <code>overflow-hidden</code> auf Container, <code>min-w-0</code> auf flex-children.</p>
  <div class="files">src/components/messages/conversation-view.tsx</div>
</div>

<div class="bug-item">
  <h3>2.8 Chat Header</h3>
  <p><span class="problem">Problem:</span> Doppelte Back-Buttons, nicht optimal auf Mobile.</p>
  <p><span class="solution">Lösung:</span> Buttons konsolidiert, responsive Gaps/Padding, kleinerer Avatar auf Mobile.</p>
</div>

<div class="bug-item">
  <h3>2.9 Message Bubbles</h3>
  <p><span class="problem">Problem:</span> Bubbles zu breit auf kleinen Screens.</p>
  <p><span class="solution">Lösung:</span> <code>max-w-[80%]</code> auf Mobile (vorher 75%), <code>overflow-hidden</code> auf Text.</p>
</div>

<div class="bug-item">
  <h3>2.10 AppShell Layout</h3>
  <p><span class="problem">Problem:</span> Horizontales Scrolling auf verschiedenen Seiten.</p>
  <p><span class="solution">Lösung:</span> <code>min-w-0 overflow-hidden</code> auf main-Element.</p>
  <div class="files">src/components/layout/app-shell.tsx</div>
</div>

<hr>

<h2>3. Git Commits</h2>
<table>
  <thead><tr><th>Commit</th><th>Beschreibung</th></tr></thead>
  <tbody>
    <tr><td><span class="commit-hash">c85accb</span></td><td>fix: mobile UI for admin table and chat view</td></tr>
    <tr><td><span class="commit-hash">3df07e8</span></td><td>fix: admin tables horizontal scroll on mobile</td></tr>
    <tr><td><span class="commit-hash">1d4fec7</span></td><td>fix: comprehensive mobile UI overhaul</td></tr>
    <tr><td><span class="commit-hash">7fa17fb</span></td><td>fix: mobile UI fixes for dialogs, notifications, settings</td></tr>
    <tr><td><span class="commit-hash">b01070e</span></td><td>fix: mobile UI improvements</td></tr>
    <tr><td><span class="commit-hash">521564c</span></td><td>style: UI improvements and mobile fixes</td></tr>
    <tr><td><span class="commit-hash">a06aada</span></td><td>feat: OSRM Integration - Echte Road-Routing</td></tr>
    <tr><td><span class="commit-hash">a3332da</span></td><td>feat: Route Watches - Benachrichtigungen</td></tr>
    <tr><td><span class="commit-hash">c1cddaf</span></td><td>fix: Infinite Loop - Routing Calculation</td></tr>
    <tr><td><span class="commit-hash">b1ffb7c</span></td><td>fix: Routing Loop & Counter</td></tr>
    <tr><td><span class="commit-hash">72b631b</span></td><td>fix: Optional route_geometry</td></tr>
    <tr><td><span class="commit-hash">2eb76d8</span></td><td>fix: Simplify ride creation</td></tr>
    <tr><td><span class="commit-hash">4da16a0</span></td><td>fix: Disable route_geometry (temporär)</td></tr>
  </tbody>
</table>

<hr>

<h2>4. Bekannte Einschränkungen</h2>

<h3>4.1 Route Geometry (temporär deaktiviert)</h3>
<ul>
  <li><strong>Status:</strong> Spalten <code>route_geometry</code>, <code>route_distance</code>, <code>route_duration</code> deaktiviert</li>
  <li><strong>Grund:</strong> PostgreSQL 22P02 Fehler</li>
  <li><strong>Auswirkung:</strong> Keine - Routen werden trotzdem berechnet</li>
</ul>

<h3>4.2 OSRM Demo Server</h3>
<ul>
  <li><strong>Status:</strong> Nutzt öffentlichen Demo-Server (rate-limited)</li>
  <li><strong>Empfehlung:</strong> Self-Hosting für Produktion</li>
</ul>

<hr>

<h2>5. Offene Punkte / Nächste Schritte</h2>

<h3>Vor Go-Live zu erledigen:</h3>
<ol>
  <li><strong>Stripe Integration</strong> - Produktiv-Keys einrichten</li>
  <li><strong>E-Mail-Templates</strong> - Transaktionale E-Mails konfigurieren</li>
  <li><strong>Rechtliches</strong> - AGB, Datenschutz finalisieren</li>
  <li><strong>Testing</strong> - End-to-End Tests durchführen</li>
  <li><strong>Monitoring</strong> - Error-Tracking einrichten (z.B. Sentry)</li>
  <li><strong>OSRM</strong> - Self-Hosting für Produktion evaluieren</li>
</ol>

<h3>Kostenlose vs. Premium Version:</h3>
<ul>
  <li>Dokumentation der Feature-Unterschiede erforderlich</li>
  <li>Paywall-Logik verifizieren</li>
</ul>

<hr>
<p style="text-align: center; color: #666; font-size: 0.85rem; margin-top: 3rem;">
  Erstellt mit Claude Opus 4.5 | Fahr mit! - Mitfahrbörse
</p>

</body>
</html>
